# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main
- feature/*

pool:
  vmImage: ubuntu-latest

variables:
  - group: acr-variable-group
  - name: HELM_EXPERIMENTAL_OCI
    value: 1

stages:
- stage: Package
  displayName: Helm Package and Push
  jobs:
  - job: Package
    displayName: Helm Package and Push
    steps:
      - task: HelmInstaller@0
        inputs:
          helmVersion: '3.7.1'
        displayName: Helm Installer
          
      - bash: |
          echo $(acrPassword) | helm registry login $(acrName).azurecr.io --username $(acrUsername) --password-stdin
        failOnStderr: true
        displayName: 'Helm ACR Login'

      - template: ./pipeline-templates/package-push-chart.yml
        parameters:
          environments:
            - qa
            - prod  
          projectsName:
            - app-one-api

